name: Add URL to data.json

on:
  issues:
    types: [opened]

env:
  BRANCH_NAME: 32-add-support-to-add-extra-posts-to-a-newsfeed

jobs:
  add-url:
    if: contains(github.event.issue.labels.*.name, 'add-url')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}

      - name: Extract URL from issue body
        id: extract-url
        run: |
          echo "Issue body: ${{ github.event.issue.body }}"
          URL=$(echo "${{ github.event.issue.body }}" | grep -o 'http[s]*://[^ ]*' || true)
          echo "URL: $URL"
          if [ -z "$URL" ]; then
            ERROR_MESSAGE="Error: No valid URL found in the issue body."
            echo $ERROR_MESSAGE
            echo "ERROR_MESSAGE=$ERROR_MESSAGE" >> $GITHUB_ENV
            exit 1
          fi
          echo "URL=$URL" >> $GITHUB_ENV

      - name: Validate URL
        id: validate-url
        run: |
          URL=${{ env.URL }}
          if ! curl --output /dev/null --silent --head --fail "$URL"; then
            ERROR_MESSAGE="Error: Site ($URL) cannot be loaded."
            echo $ERROR_MESSAGE
            echo "ERROR_MESSAGE=$ERROR_MESSAGE" >> $GITHUB_ENV
            exit 1
          fi
          echo "URL successfully loaded"

      - name: Fetch URL title
        id: fetch-title
        run: |
          URL=${{ env.URL }}
          TITLE=$(curl -s $URL | grep -o '<title>[^<]*' | sed 's/<title>//' | tr -d '\n')
          if [ -z "$TITLE" ]; then
            ERROR_MESSAGE="Error: Unable to fetch title from URL."
            echo $ERROR_MESSAGE
            echo "ERROR_MESSAGE=$ERROR_MESSAGE" >> $GITHUB_ENV
            exit 1
          fi
          echo "TITLE=$TITLE" >> $GITHUB_ENV

      - name: Comment on issue and close if validation fails
        if: failure()
        run: |
          ERROR_MESSAGE="${{ env.ERROR_MESSAGE }}"
          ISSUE_NUMBER=${{ github.event.issue.number }}
          COMMENT="The addition of th URL is aborted due to the following error: $ERROR_MESSAGE"
          gh issue close $ISSUE_NUMBER --comment "$COMMENT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date
        id: get-date
        run: |
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "DATE=$DATE" >> $GITHUB_ENV

      - name: Update data.json
        run: |
          URL='${{ env.URL }}'
          TITLE='${{ env.TITLE }}'
          DATE='${{ env.DATE }}'
          jq --arg url "$URL" --arg title "$TITLE" --arg date "$DATE" \
            '.manualUrls += [{"url": $url, "title": $title, "dateAdded": $date}]' public/data.json > tmp.json && mv tmp.json public/data.json

      - name: Commit changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/data.json
          git commit -m "Add URL from issue #${{ github.event.issue.number }}"
          git push origin HEAD:${{ env.BRANCH_NAME }}
      
      - name: Comment on issue and close after successful addition
        if: success()
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          COMMENT="The URL was added to the list successfully. Another workflow will be triggered to deploy the changes."
          gh issue close $ISSUE_NUMBER --comment "$COMMENT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}